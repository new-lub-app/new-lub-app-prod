version: '3.8'

services:
    # Application Symfony
    app:
        build: 
            context: .
            dockerfile: Dockerfile
        container_name: symfony_app
        restart: unless-stopped
        working_dir: /var/www/symfony
        volumes:
            - .:/var/www/symfony
            - vendor:/var/www/symfony/vendor
            - symfony_cache:/var/www/symfony/var/cache
            - symfony_logs:/var/www/symfony/var/log
        depends_on:
            database:
                condition: service_healthy
        environment:
            - APP_ENV=dev
            - APP_DEBUG=1
            - DATABASE_URL=mysql://symfony:symfony@database:3306/symfony_db?serverVersion=8.0
            - PHP_IDE_CONFIG=serverName=symfony-docker
        networks:
            - symfony_network

    # Serveur web Nginx
    nginx:
        image: nginx:alpine
        container_name: symfony_nginx
        restart: unless-stopped
        ports:
            - "8089:80"
        volumes:
            - .:/var/www/symfony:ro
            - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
            - nginx_logs:/var/log/nginx
        depends_on:
            - app
        networks:
            - symfony_network
        healthcheck:
            test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # Base de données MySQL
    database:
        image: mysql:8.0
        container_name: symfony_db
        restart: unless-stopped
        environment:
            MYSQL_DATABASE: symfony_db
            MYSQL_USER: symfony
            MYSQL_PASSWORD: symfony
            MYSQL_ROOT_PASSWORD: root
        ports:
            - "3307:3306"
        volumes:
            - mysql_data:/var/lib/mysql
            - ./docker/mysql/init:/docker-entrypoint-initdb.d:ro
        networks:
            - symfony_network
        command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s

    # phpMyAdmin
    phpmyadmin:
        image: phpmyadmin:latest
        container_name: symfony_phpmyadmin
        restart: unless-stopped
        ports:
            - "8081:80"
        environment:
            PMA_HOST: database
            PMA_PORT: 3306
            PMA_USER: symfony
            PMA_PASSWORD: symfony
            UPLOAD_LIMIT: 256M
            MEMORY_LIMIT: 512M
        depends_on:
            database:
                condition: service_healthy
        networks:
            - symfony_network

    # Redis (Cache & Sessions)
    redis:
        image: redis:7-alpine
        container_name: symfony_redis
        restart: unless-stopped
        ports:
            - "6379:6379"
        volumes:
            - redis_data:/data
        networks:
            - symfony_network
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 3s
            retries: 3

    # Mailcatcher (Development Email Testing)


volumes:
    mysql_data:
        driver: local
    vendor:
        driver: local
    symfony_cache:
        driver: local
    symfony_logs:
        driver: local
    nginx_logs:
        driver: local
    redis_data:
        driver: local

networks:
    symfony_network:
        driver: bridge



# services:
#     # Application Symfony
#     app:
#         build: .
#         container_name: symfony_app
#         volumes:
#             - .:/var/www/symfony
#             - vendor:/var/www/symfony/vendor
#         depends_on:
#             - database
#         environment:
#             - APP_ENV=dev
#             - DATABASE_URL=mysql://symfony:symfony@database:3306/symfony_db

#     # Serveur web Nginx
#     nginx:
#         image: nginx:alpine
#         container_name: symfony_nginx
#         ports:
#             - "8089:80"
#         volumes:
#             - .:/var/www/symfony
#             - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf
#         depends_on:
#             - app

#     # Base de données MySQL
#     database:
#         image: mysql:8.0
#         container_name: symfony_db
#         restart: unless-stopped
#         environment:
#             MYSQL_DATABASE: symfony_db
#             MYSQL_USER: symfony
#             MYSQL_PASSWORD: symfony
#             MYSQL_ROOT_PASSWORD: root
#         ports:
#             - "3307:3306"
#         volumes:
#             - mysql_data:/var/lib/mysql

#     # phpMyAdmin (optionnel)
#     phpmyadmin:
#         image: phpmyadmin:latest
#         container_name: symfony_phpmyadmin
#         restart: unless-stopped
#         ports:
#             - "8081:80"
#         environment:
#             PMA_HOST: database
#             PMA_USER: symfony
#             PMA_PASSWORD: symfony
#         depends_on:
#             - database

# volumes:
#     mysql_data:
#     vendor:
